<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.openrtb.db.billing.BillingMapper">

   	<!-- /* select dual */ -->
	<select id="getBillingTest" resultType="java.lang.String">
		SELECT now() FROM DUAL
	</select>
	
	<!-- 시간대별 체크 영역 -->
	<select id="getBillingTimeDataList" resultType="map" parameterType="map">
		SELECT
			 STATS_DTTM
			, STATS_HH
			, ITL_TP_CODE
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
		FROM
			BILLING.MOB_ADVER_HH_STATS
		WHERE
			STATS_DTTM = #{date}
			AND ITL_TP_CODE = #{itl_tp_code}
		GROUP BY
			STATS_DTTM
			, STATS_HH
			, ITL_TP_CODE
		ORDER BY
			STATS_HH
	</select>
	
	<select id="getOepnRtbTimeDataList" resultType="map" parameterType="map">
		SELECT
			 STATS_DTTM
			, STATS_HH
			, ITL_TP_CODE
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
		FROM
			OpenRTB.ORTB_ADVER_HH_STATS
		WHERE
			STATS_DTTM = #{date}
			AND ITL_TP_CODE = #{itl_tp_code}
		GROUP BY
			STATS_DTTM
			, STATS_HH
			, ITL_TP_CODE
		ORDER BY
			STATS_HH
	</select>
	
	<!-- 일자별 체크 영역 -->
	<select id="getBillingDayDataList" resultType="map" parameterType="map">
		SELECT
			STATS_DTTM
			, ITL_TP_CODE
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
		FROM
			BILLING.MOB_CAMP_MEDIA_STATS
		WHERE
			STATS_DTTM = #{date}
			AND ITL_TP_CODE = #{itl_tp_code}
		GROUP BY
			STATS_DTTM
			, ITL_TP_CODE
	</select>
	
	<select id="getOepnRtbDayDataList" resultType="map" parameterType="map">
		SELECT
			STATS_DTTM
			, ITL_TP_CODE
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS
		WHERE
			STATS_DTTM = #{date}
			AND ITL_TP_CODE = #{itl_tp_code}
		GROUP BY
			STATS_DTTM
			, ITL_TP_CODE
	</select>
	
	<!-- 데이터 보정 영역 -->
	<!-- 시간대별 -->
	<!-- MOB_CAMP_HH_STATS -->
	<delete id="del_MOB_CAMP_HH_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_CAMP_HH_STATS WHERE STATS_DTTM = #{date} AND STATS_HH = #{time} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_CAMP_HH_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_CAMP_HH_STATS (
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, SITE_CODE
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'OPENBATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'OPENBATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_HH_STATS A
		WHERE
			A.STATS_DTTM = #{date} 
			AND A.STATS_HH = #{time}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_ADVER_HH_STATS -->
	<delete id="del_MOB_ADVER_HH_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_ADVER_HH_STATS WHERE STATS_DTTM = #{date} AND STATS_HH = #{time} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_ADVER_HH_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_ADVER_HH_STATS (
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, ADVER_ID
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'OPENBATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'OPENBATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_HH_STATS A
		WHERE
			A.STATS_DTTM = #{date} 
			AND A.STATS_HH = #{time}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_MEDIA_SCRIPT_HH_STATS -->
	<delete id="del_MOB_MEDIA_SCRIPT_HH_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_SCRIPT_HH_STATS WHERE STATS_DTTM = #{date} AND STATS_HH = #{time} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_SCRIPT_HH_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_SCRIPT_HH_STATS (
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(CLICK_CNT) AS CLICK_CNT
			, SUM(ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM (
			SELECT 
				A.STATS_DTTM
				, A.STATS_HH
				, A.PLTFOM_TP_CODE
				, A.ADVRTS_PRDT_CODE
				, A.ADVRTS_TP_CODE
				, B.MEDIA_SCRT_HIRNK_NO AS MEDIA_SCRIPT_NO
				, A.ITL_TP_CODE
				, CASE WHEN LENGTH(IFNULL(C.scate,''))=0 THEN '' WHEN LENGTH(IFNULL(C.scate,''))=1 THEN CONCAT('0',C.scate) ELSE C.scate END AS MEDIA_TP_CODE
				, A.MEDIA_ID
				, A.TOT_EPRS_CNT
				, A.PAR_EPRS_CNT
				, A.CLICK_CNT
				, A.ADVRTS_AMT
				, A.MEDIA_PYMNT_AMT
			FROM
				OpenRTB.ORTB_CAMP_MEDIA_HH_STATS A
				INNER JOIN dreamsearch.MEDIA_PAR_MGMT B ON  B.MEDIA_SCRT_NO = A.MEDIA_SCRIPT_NO
				LEFT OUTER JOIN (
					SELECT b.scate,a.no 
					FROM dreamsearch.media_script a 
					LEFT JOIN dreamsearch.media_site b 
					ON a.mediasite_no=b.no 
				) C ON B.MEDIA_SCRT_HIRNK_NO = C.no
			WHERE
				1=1
				AND A.STATS_DTTM = #{date} 
				AND A.STATS_HH = #{time}
				AND A.ITL_TP_CODE = #{itl_tp_code}
		) ORI
		GROUP BY 
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
	</update>
	
	<!-- MOB_MEDIA_HH_STATS -->
	<delete id="del_MOB_MEDIA_HH_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_HH_STATS WHERE STATS_DTTM = #{date} AND STATS_HH = #{time} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_HH_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_HH_STATS (
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_ID
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_HH_STATS A
		WHERE
			A.STATS_DTTM = #{date} 
			AND A.STATS_HH = #{time}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_COM_HH_STATS_INFO -->
	<delete id="del_MOB_COM_HH_STATS_INFO" parameterType="map">
		DELETE FROM BILLING.MOB_COM_HH_STATS_INFO WHERE STATS_DTTM = #{date} AND STATS_HH = #{time} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_COM_HH_STATS_INFO" parameterType="map">
		INSERT INTO BILLING.MOB_COM_HH_STATS_INFO (
			STATS_DTTM
			, STATS_HH
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_HH_STATS A
		WHERE
			A.STATS_DTTM = #{date} 
			AND A.STATS_HH = #{time}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.STATS_HH
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ITL_TP_CODE
	</update>
	
	<!-- 일자별 -->
	<!-- MOB_CAMP_MEDIA_STATS -->
	<delete id="del_MOB_CAMP_MEDIA_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_CAMP_MEDIA_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_CAMP_MEDIA_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_CAMP_MEDIA_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, SITE_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, ADVER_ID
			, MEDIA_ID
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, B.MEDIA_SCRT_HIRNK_NO AS MEDIA_SCRIPT_NO
			, A.ITL_TP_CODE
			, A.ADVER_ID
			, A.MEDIA_ID
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'OPENBATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'OPENBATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
			, dreamsearch.MEDIA_PAR_MGMT B
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
			AND B.MEDIA_SCRT_NO = A.MEDIA_SCRIPT_NO
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, B.MEDIA_SCRT_HIRNK_NO
			, A.ITL_TP_CODE
			, A.ADVER_ID
			, A.MEDIA_ID
	</update>
	
	<!-- MOB_CAMP_STATS -->
	<delete id="del_MOB_CAMP_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_CAMP_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_CAMP_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_CAMP_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, SITE_CODE
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.SITE_CODE
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_ADVER_MEDIA_STATS -->
	<delete id="del_MOB_ADVER_MEDIA_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_ADVER_MEDIA_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_ADVER_MEDIA_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_ADVER_MEDIA_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, ADVER_ID
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, B.MEDIA_SCRT_HIRNK_NO AS MEDIA_SCRIPT_NO
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
			, dreamsearch.MEDIA_PAR_MGMT B
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
			AND B.MEDIA_SCRT_NO = A.MEDIA_SCRIPT_NO
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, B.MEDIA_SCRT_HIRNK_NO
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_ADVER_STATS -->
	<delete id="del_MOB_ADVER_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_ADVER_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_ADVER_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_ADVER_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, ADVER_ID
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ADVER_ID
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_MEDIA_SCRIPT_STATS -->
	<delete id="del_MOB_MEDIA_SCRIPT_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_SCRIPT_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_SCRIPT_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_SCRIPT_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(CLICK_CNT) AS CLICK_CNT
			, SUM(ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM (
			SELECT 
				A.STATS_DTTM
				, A.PLTFOM_TP_CODE
				, A.ADVRTS_PRDT_CODE
				, A.ADVRTS_TP_CODE
				, B.MEDIA_SCRT_HIRNK_NO AS MEDIA_SCRIPT_NO
				, A.ITL_TP_CODE
				, CASE WHEN LENGTH(IFNULL(C.scate,''))=0 THEN '' WHEN LENGTH(IFNULL(C.scate,''))=1 THEN CONCAT('0',C.scate) ELSE C.scate END AS MEDIA_TP_CODE
				, A.MEDIA_ID
				, A.TOT_EPRS_CNT
				, A.PAR_EPRS_CNT
				, A.CLICK_CNT
				, A.ADVRTS_AMT
				, A.MEDIA_PYMNT_AMT
			FROM
				OpenRTB.ORTB_CAMP_MEDIA_STATS A
				INNER JOIN dreamsearch.MEDIA_PAR_MGMT B ON  B.MEDIA_SCRT_NO = A.MEDIA_SCRIPT_NO
				LEFT OUTER JOIN (
					SELECT b.scate,a.no 
					FROM dreamsearch.media_script a 
					LEFT JOIN dreamsearch.media_site b 
					ON a.mediasite_no=b.no 
				) C ON B.MEDIA_SCRT_HIRNK_NO = C.no
			WHERE
				1=1
				AND A.STATS_DTTM = #{date}
				AND A.ITL_TP_CODE = #{itl_tp_code}
		) ORI
		GROUP BY 
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
	</update>
	
	<!-- MOB_MEDIA_STATS -->
	<delete id="del_MOB_MEDIA_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_ID
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_COM_STATS_INFO -->
	<delete id="del_MOB_COM_STATS_INFO" parameterType="map">
		DELETE FROM BILLING.MOB_COM_STATS_INFO WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_COM_STATS_INFO" parameterType="map">
		INSERT INTO BILLING.MOB_COM_STATS_INFO (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, RETRN_CNT
			, AVAL_CNT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 0 AS RETRN_CNT
			, 0 AS AVAL_CNT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.ITL_TP_CODE
	</update>
	
	<!-- MOB_MEDIA_SCRIPT_CHRG_STATS -->
	<delete id="del_MOB_MEDIA_SCRIPT_CHRG_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_SCRIPT_CHRG_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_SCRIPT_CHRG_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_SCRIPT_CHRG_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
			, SUM(TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(CLICK_CNT) AS CLICK_CNT
			, SUM(ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM (
			SELECT 
				A.STATS_DTTM
				, A.PLTFOM_TP_CODE
				, A.ADVRTS_PRDT_CODE
				, A.ADVRTS_TP_CODE
				, B.MEDIA_SCRT_HIRNK_NO AS MEDIA_SCRIPT_NO
				, A.ITL_TP_CODE
				, CASE WHEN LENGTH(IFNULL(C.scate,''))=0 THEN '' WHEN LENGTH(IFNULL(C.scate,''))=1 THEN CONCAT('0',C.scate) ELSE C.scate END AS MEDIA_TP_CODE
				, A.MEDIA_ID
				, A.TOT_EPRS_CNT
				, A.PAR_EPRS_CNT
				, A.CLICK_CNT
				, A.ADVRTS_AMT
				, A.MEDIA_PYMNT_AMT
			FROM
				OpenRTB.ORTB_CAMP_MEDIA_STATS A
				INNER JOIN dreamsearch.MEDIA_PAR_MGMT B ON  B.MEDIA_SCRT_NO = A.MEDIA_SCRIPT_NO
				LEFT OUTER JOIN (
					SELECT b.scate,a.no 
					FROM dreamsearch.media_script a 
					LEFT JOIN dreamsearch.media_site b 
					ON a.mediasite_no=b.no 
				) C ON B.MEDIA_SCRT_HIRNK_NO = C.no
			WHERE
				1=1
				AND A.STATS_DTTM = #{date}
				AND A.ITL_TP_CODE = #{itl_tp_code}
		) ORI
		GROUP BY 
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_SCRIPT_NO
			, ITL_TP_CODE
			, MEDIA_TP_CODE
			, MEDIA_ID
	</update>
	
	<!-- MOB_MEDIA_CHRG_STATS -->
	<delete id="del_MOB_MEDIA_CHRG_STATS" parameterType="map">
		DELETE FROM BILLING.MOB_MEDIA_CHRG_STATS WHERE STATS_DTTM = #{date} AND ITL_TP_CODE = #{itl_tp_code}
	</delete>
	
	<update id="insert_MOB_MEDIA_CHRG_STATS" parameterType="map">
		INSERT INTO BILLING.MOB_MEDIA_CHRG_STATS (
			STATS_DTTM
			, PLTFOM_TP_CODE
			, ADVRTS_PRDT_CODE
			, ADVRTS_TP_CODE
			, MEDIA_ID
			, ITL_TP_CODE
			, TOT_EPRS_CNT
			, PAR_EPRS_CNT
			, CLICK_CNT
			, ADVRTS_AMT
			, MEDIA_PYMNT_AMT
			, TRGT_EPRS_CNT
			, TRGT_PAR_EPRS_CNT
			, TRGT_CLICK_CNT
			, TRGT_ADVRTS_AMT
			, REG_USER_ID
			, REG_DTTM
			, ALT_USER_ID
			, ALT_DTTM
		)
		SELECT 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
			, SUM(A.TOT_EPRS_CNT) AS TOT_EPRS_CNT
			, SUM(A.PAR_EPRS_CNT) AS PAR_EPRS_CNT
			, SUM(A.CLICK_CNT) AS CLICK_CNT
			, SUM(A.ADVRTS_AMT) AS ADVRTS_AMT
			, SUM(A.MEDIA_PYMNT_AMT) AS MEDIA_PYMNT_AMT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.TOT_EPRS_CNT) ELSE 0 END AS TRGT_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.PAR_EPRS_CNT) ELSE 0 END AS TRGT_PAR_EPRS_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.CLICK_CNT) ELSE 0 END AS TRGT_CLICK_CNT
			, CASE WHEN A.ADVRTS_TP_CODE IN ('04','10','16','17','34','37','40','41','42','47','48') THEN SUM(A.ADVRTS_AMT) ELSE 0 END AS TRGT_ADVRTS_AMT
			, 'BATCH' AS REG_USER_ID
			, NOW() AS REG_DTTM
			, 'BATCH' AS ALT_USER_ID
			, NOW() AS ALT_DTTM
		FROM
			OpenRTB.ORTB_CAMP_MEDIA_STATS A
		WHERE
			A.STATS_DTTM = #{date}
			AND A.ITL_TP_CODE = #{itl_tp_code}
		GROUP BY 
			A.STATS_DTTM
			, A.PLTFOM_TP_CODE
			, A.ADVRTS_PRDT_CODE
			, A.ADVRTS_TP_CODE
			, A.MEDIA_ID
			, A.ITL_TP_CODE
	</update>
</mapper>